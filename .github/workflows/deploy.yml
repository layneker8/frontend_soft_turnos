name: Deploy a VPS

on:
  push:
    branches: [main]
  workflow_dispatch: # Permite ejecuci√≥n manual

jobs:
  deploy:
    name: Deploy a VPS
    runs-on: ubuntu-latest
    environment: iturno

    steps:
      - name: Validar que los secrets existen
        run: |
          if [ -z "${{ secrets.VPS_HOST }}" ]; then
            echo "‚ùå Error: VPS_HOST no est√° configurado"
            exit 1
          fi
          if [ -z "${{ secrets.VPS_USER }}" ]; then
            echo "‚ùå Error: VPS_USER no est√° configurado"
            exit 1
          fi
          if [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "‚ùå Error: VPS_SSH_KEY no est√° configurado"
            exit 1
          fi
          if [ -z "${{ secrets.VPS_PROJECT_PATH }}" ]; then
            echo "‚ùå Error: VPS_PROJECT_PATH no est√° configurado"
            exit 1
          fi
          echo "‚úÖ Todos los secrets est√°n configurados correctamente"
          echo "üîç Detalles:"
          echo "   Host: ${{ secrets.VPS_HOST }}"
          echo "   Usuario: ${{ secrets.VPS_USER }}"
          echo "   Ruta proyecto: ${{ secrets.VPS_PROJECT_PATH }}"

      - name: Deploy mediante SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            # Ir al directorio del proyecto
            cd ${{ secrets.VPS_PROJECT_PATH }}

            # Actualizar c√≥digo desde GitHub
            echo "üì• Obteniendo √∫ltimos cambios..."
            git pull origin main

            # Instalar/actualizar dependencias
            echo "üì¶ Instalando dependencias..."
            npm install

            # Build de producci√≥n
            echo "üèóÔ∏è Compilando proyecto..."
            npm run build

            # Reiniciar servidor web (ajusta seg√∫n tu configuraci√≥n)
            # Opci√≥n 1: Nginx
            #echo "üîÑ Reiniciando servidor..."
            #sudo systemctl reload nginx

            # Opci√≥n 2: PM2 (si usas Node.js server)
            # pm2 restart soft-turnos-frontend

            # Opci√≥n 3: Docker (si usas contenedor)
            # docker-compose up -d --build

            echo "‚úÖ Deploy completado!"

      - name: Notificaci√≥n de deploy exitoso
        if: success()
        run: echo "‚úÖ Aplicaci√≥n desplegada exitosamente en VPS!"

      - name: Notificaci√≥n de error
        if: failure()
        run: echo "‚ùå Error durante el deploy. Revisa los logs."
